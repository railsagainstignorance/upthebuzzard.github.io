<script>
  (function() {

    const JSON_URL = '/search.json';

    function urlParam(name){
      var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
      if (results==null){
         return null;
      }
      else{
         return decodeURIComponent(results[1]) || 0;
      }
    }

    function getAndProcessJsonThen( thenFn ) {
      var oReq    = new XMLHttpRequest();
      oReq.onload = processJson;
      oReq.open("get", JSON_URL, true);
      oReq.send(null);

      function processJson(e) {
        if (this.status != 200) {
          console.log("Error: failed to processJson: status=" + this.status);
          return;
        }

        var json = JSON.parse(oReq.responseText);
        thenFn(json);
      }
    }

    function displayResults(json){
      const q = urlParam('q');
      const resultsDivElt = document.getElementById('results');
      if (! resultsDivElt) {
        console.log("Error: could not find 'results' element");
        return;
      }
      const resultsH2Elt = resultsDivElt.getElementsByTagName('h2')[0];
      if (! resultsH2Elt) {
        console.log("Error: could not find results h2 element");
        return;
      }

      resultsH2Elt.textContent = "Search Results: " + q;

      const resultsUlElt = resultsDivElt.getElementsByTagName('ul')[0];
      if (! resultsUlElt) {
        console.log("Error: could not find results ul element");
        return;
      }

      const re = new RegExp(q, 'i');
      const knownPageHrefs = {};
      const textFieldsToScan = ['title', 'content'];

      textFieldsToScan.forEach( textField => {
        json.forEach(page => {
          if (
            page
            && page.href.endsWith('.html')
            && !knownPageHrefs[page.href]
            && page[textField].match(re)
          ) {
              knownPageHrefs[page.href] = true;
              const li      = document.createElement("li");
              const linkElt = document.createElement("a");
              linkElt.href = page.href;
              const text = page.title + ((page.categories.includes("story"))? " (story)": "");
              linkElt.textContent = text;
              li.appendChild(linkElt);
              resultsUlElt.appendChild(li);
          }
        });
      });
    }

    getAndProcessJsonThen( displayResults );
  })();
</script>
